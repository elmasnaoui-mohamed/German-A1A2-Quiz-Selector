<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deutsch-Arabisch Lernplattform</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for responsiveness and appearance */
        :root {
            --bg-color: #f9fafb;
            /* Light Gray-50 */
            --text-color: #1f2937;
            /* Dark Gray-800 */
        }

        .dark {
            --bg-color: #111827;
            /* Dark Gray-900 */
            --text-color: #f9fafb;
            /* White */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Custom focus states for accessibility */
        button:focus,
        input:focus,
        select:focus,
        a:focus {
            outline: 2px solid theme('colors.blue.500');
            outline-offset: 2px;
        }

        .quiz-option:focus {
            box-shadow: 0 0 0 4px theme('colors.blue.500');
        }

        /* RTL adjustments */
        [dir="rtl"] .ml-1 {
            margin-left: 0.25rem;
            margin-right: 0.25rem;
        }

        [dir="rtl"] .mr-2 {
            margin-right: 0rem;
            margin-left: 0.5rem;
        }

        [dir="rtl"] .text-left {
            text-align: right;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Arial', 'sans-serif'],
                    },
                },
            }
        }
    </script>
</head>

<body id="app-body" class="min-h-screen">
    <div id="app-root" class="min-h-screen">
        <!-- Content will be rendered here by JavaScript -->
        <div class="flex items-center justify-center h-screen text-xl text-gray-500 dark:text-gray-400">Loading
            application...</div>
    </div>

    <div id="toast" aria-live="polite"
        class="fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-3 rounded-lg shadow-xl transition-opacity duration-300 opacity-0 pointer-events-none z-50">
    </div>

    <script type="module">
        // --- GLOBAL CONFIGURATION AND DATA (Embedded JSON) ---

        const L = {
            de: {
                appTitle: "Deutsch-Arabisch Lernplattform",
                home: "Startseite (Home)",
                words: "Wortschatz (Vocabulary)",
                grammar: "Grammatik (Grammar)",
                review: "Wiederholung (Review)",
                settings: "Einstellungen (Settings)",
                currentLang: "Aktuelle Sprache",
                theme: "Design",
                light: "Hell (Light)",
                dark: "Dunkel (Dark)",
                dueItems: "Fällig heute",
                totalItems: "Gesamt",
                level: "Niveau",
                topic: "Thema",
                startQuiz: "Quiz starten (Start Quiz)",
                next: "Weiter",
                showAnswer: "Antwort zeigen",
                typeAnswer: "Gib die Antwort ein...",
                correct: "Richtig! ✅",
                incorrect: "Falsch! ❌",
                answerWas: "Die richtige Antwort war:",
                progress: "Fortschritt",
                resetProgress: "Fortschritt zurücksetzen (Reset Progress)",
                importProgress: "Fortschritt importieren (Import Progress)",
                exportProgress: "Fortschritt exportieren (Export Progress)",
                leniency: "Tipp-Toleranz",
                confirmReset: "Sind Sie sicher, dass Sie Ihren gesamten Fortschritt zurücksetzen möchten?",
                confirmResetBtnText: "Zurücksetzung bestätigen (Confirm Reset)",
                cancelBtnText: "Abbrechen (Cancel)",
                importSuccess: "Fortschritt erfolgreich importiert.",
                importFail: "Fehler beim Import. Ungültiges Format.",
                notDue: "Keine Karten fällig. Gut gemacht!",
                sessionComplete: "Sitzung abgeschlossen.",
                welcome: "Willkommen! Wählen Sie eine Kategorie, um zu starten.",
                prepB1: "Bereiten Sie sich auf B1 vor!",
                totalLearned: "Gelernte Einheiten",
                attempts: "Versuche",
                correctCount: "Richtig",
                streak: "Serie",
                filterLevel: "Nach Niveau filtern (Filter Level)",
                filterType: "Nach Fragetyp filtern",
                confirmAnswer: "Antwort prüfen",
            },
            ar: {
                appTitle: "منصة تعلم الألمانية-العربية", home: "الصفحة الرئيسية", words: "المفردات", grammar: "القواعد",
                review: "المراجعة", settings: "الإعدادات", currentLang: "اللغة الحالية", theme: "المظهر",
                light: "فاتح", dark: "داكن", dueItems: "العناصر المستحقة اليوم", totalItems: "الإجمالي", level: "المستوى", topic: "الموضوع",
                startQuiz: "بدء الاختبار", next: "التالي",
                showAnswer: "إظهار الإجابة",
                typeAnswer: "...أدخل الإجابة",
                correct: "صحيح! ✅", incorrect: "خطأ! ❌", answerWas: "الإجابة الصحيحة كانت:", progress: "التقدم",
                resetProgress: "إعادة تعيين التقدم", importProgress: "استيراد التقدم", exportProgress: "تصدير التقدم",
                leniency: "تسامح في الكتابة", confirmReset: "هل أنت متأكد أنك تريد إعادة تعيين كل تقدمك؟", importSuccess: "تم استيراد التقدم بنجاح.",
                confirmResetBtnText: "تأكيد الإعادة",
                cancelBtnText: "إلغاء",
                importFail: "فشل الاستيراد. تنسيق غير صالح.", notDue: "لا توجد بطاقات مستحقة. عمل جيد!", sessionComplete: "اكتملت الجلسة.",
                welcome: "مرحبًا! اختر فئة لتبدأ.", prepB1: "استعد لمستوى B1!", totalLearned: "الوحدات المتعلمة", attempts: "المحاولات",
                correctCount: "الصحيح", streak: "سلسلة النجاح", filterLevel: "تصفية حسب المستوى", filterType: "تصفية حسب نوع السؤال",
                confirmAnswer: "التحقق من الإجابة",
            }
        };

        // Base seed data for generating 200 unique words
        const baseWordSeeds = [
            { "de": "das Buch", "ar": "الكتاب", "pos": "Nomen", "gender": "das", "example_de": "Das Buch ist neu.", "example_ar": "الكتاب جديد.", "distractors_de": ["das Heft", "die Zeitung", "der Stift"], "tags": ["schule"] },
            { "de": "lernen", "ar": "يتعلم", "pos": "Verb", "example_de": "Ich lerne Deutsch.", "example_ar": "أنا أتعلم الألمانية.", "distractors_de": ["lehren", "arbeiten", "spielen"], "tags": ["bildung"] },
            { "de": "kalt", "ar": "بارد", "pos": "Adjektiv", "example_de": "Es ist kalt draußen.", "example_ar": "الجو بارد في الخارج.", "distractors_de": ["warm", "heiß", "kühl"], "tags": ["wetter"] },
            { "de": "die Straße", "ar": "الشارع", "pos": "Nomen", "gender": "die", "example_de": "Die Straße ist lang.", "example_ar": "الشارع طويل.", "distractors_de": ["der Weg", "der Platz", "der Park"], "tags": ["stadt"] },
            { "de": "bezahlen", "ar": "يدفع", "pos": "Verb", "example_de": "Ich muss die Rechnung bezahlen.", "example_ar": "يجب أن أدفع الفاتورة.", "distractors_de": ["kaufen", "verkaufen", "holen"], "tags": ["finanzen"] },
            { "de": "interessant", "ar": "مثير للاهتمام", "pos": "Adjektiv", "example_de": "Der Film ist interessant.", "example_ar": "الفيلم مثير للاهتمام.", "distractors_de": ["langweilig", "schlecht", "einfach"], "tags": ["allgemein"] },
            { "de": "der Bahnhof", "ar": "محطة القطار", "pos": "Nomen", "gender": "der", "example_de": "Wo ist der Bahnhof?", "example_ar": "أين محطة القطار؟", "distractors_de": ["der Flughafen", "die Haltestelle", "das Rathaus"], "tags": ["reisen"] },
            { "de": "essen", "ar": "يأكل", "pos": "Verb", "example_de": "Wir essen zu Mittag.", "example_ar": "نحن نأكل الغداء.", "distractors_de": ["trinken", "schlafen", "gehen"], "tags": ["essen"] },
            { "de": "schön", "ar": "جميل", "pos": "Adjektiv", "example_de": "Das Wetter ist schön.", "example_ar": "الطقس جميل.", "distractors_de": ["hässlich", "groß", "klein"], "tags": ["allgemein"] },
            { "de": "die Familie", "ar": "العائلة", "pos": "Nomen", "gender": "die", "example_de": "Meine Familie ist hier.", "example_ar": "عائلتي هنا.", "distractors_de": ["der Freund", "die Kollegen", "der Nachbar"], "tags": ["leben"] },
        ];

        // Base seed data for generating 200 unique grammar items
        const baseGrammarSeeds = [
            // Question changed from "___ ist das dein Hund?" to "___ das dein Hund?" 
            // to clearly indicate the verb is the missing part of the sentence.
            { "topic": "Nominativ", "rule_de": "Wer/Was?", "rule_ar": "من/ماذا؟", "question": "___ das dein Hund?", "answer": "Ist", "explanation_de": "Ja/Nein Frage beginnt mit dem Verb an Position 1.", "explanation_ar": "سؤال نعم/لا يبدأ بالفعل في الموضع الأول.", "distractors": ["Was", "Wo", "Wann"], "tags": ["kasus"] },
            { "topic": "Verben", "rule_de": "Konjugation", "rule_ar": "تصريف", "question": "Wir ___ heute Abend Pizza.", "answer": "machen", "explanation_de": "Konjugation für 'wir'.", "explanation_ar": "تصريف لـ 'نحن'.", "distractors": ["machst", "macht", "mache"], "tags": ["verben"] },
            { "topic": "Dativ", "rule_de": "Wem? (Person)", "rule_ar": "لمن؟ (شخص)", "question": "Ich gebe ___ Mann das Buch.", "answer": "dem", "explanation_de": "Dativ maskulin Artikel.", "explanation_ar": "أداة النصب المذكر.", "distractors": ["der", "den", "des"], "tags": ["kasus"] },
            { "topic": "Präposition", "rule_de": "Mit Akkusativ", "rule_ar": "مع حالة النصب", "question": "Wir fahren ___ die Stadt.", "answer": "durch", "explanation_de": "'durch' mit Akkusativ.", "explanation_ar": "'durch' مع حالة النصب.", "distractors": ["bei", "mit", "von"], "tags": ["präpositionen"] },
            { "topic": "Perfekt", "rule_de": "Haben/Sein + Partizip II", "rule_ar": "Haben/Sein + اسم المفعول", "question": "Er ___ gestern ins Kino gegangen.", "answer": "ist", "explanation_de": "Bewegungsverben nutzen 'sein'.", "explanation_ar": "أفعال الحركة تستخدم 'sein'.", "distractors": ["hat", "wird", "war"], "tags": ["zeiten"] },
            { "topic": "Modalverben", "rule_de": "Müssen, dürfen, können...", "rule_ar": "الأفعال المساعدة", "question": "Du ___ mir helfen.", "answer": "musst", "explanation_de": "Konjugation von 'müssen'.", "explanation_ar": "تصريف 'müssen'.", "distractors": ["kannst", "darfst", "willst"], "tags": ["verben"] },
            { "topic": "Adjektive", "rule_de": "Adjektivdeklination", "rule_ar": "تصريف الصفات", "question": "Ich habe einen ___ Hund gesehen.", "answer": "großen", "explanation_de": "Akkusativ maskulin, schwache Deklination.", "explanation_ar": "نصب مذكر, تصريف ضعيف.", "distractors": ["groß", "große", "großes"], "tags": ["adjektive"] },
            { "topic": "Temporale Nebensätze", "rule_de": "Wenn, als, während...", "rule_ar": "جمل زمنية فرعية", "question": "___ ich klein war, spielte ich oft.", "answer": "Als", "explanation_de": "'Als' für einmalige Handlung in der Vergangenheit.", "explanation_ar": "'Als' للحدث الوحيد في الماضي.", "distractors": ["Wenn", "Während", "Bevor"], "tags": ["nebensätze"] },
            { "topic": "Possessivpronomen", "rule_de": "Mein, dein, sein...", "rule_ar": "ضمائر الملكية", "question": "Ist das ___ Auto?", "answer": "dein", "explanation_de": "Nominativ Singular neutral.", "explanation_ar": "رفع مفرد مذكر.", "distractors": ["deine", "deinem", "deinen"], "tags": ["pronomen"] },
            { "topic": "Reflexive Verben", "rule_de": "sich + Akkusativ/Dativ", "rule_ar": "أفعال انعكاسية", "question": "Ich ziehe ___ an.", "answer": "mich", "explanation_de": "sich anziehen + Akkusativ.", "explanation_ar": "sich anziehen + حالة النصب.", "distractors": ["mir", "dich", "dir"], "tags": ["verben"] },
        ];

        // Function to generate unique words
        const generateUniqueWords = (count = 200) => {
            const words = [];
            for (let i = 1; i <= count; i++) {
                const seed = baseWordSeeds[(i - 1) % baseWordSeeds.length];
                const level = i <= 100 ? "A1" : "A2";
                words.push({
                    "id": `w-${level}-${String(i).padStart(3, '0')}`,
                    "de": seed.de,
                    "ar": seed.ar,
                    "pos": seed.pos,
                    "gender": seed.gender,
                    "example_de": seed.example_de,
                    "example_ar": seed.example_ar,
                    // Ensure quiz structure is consistent for distractor retrieval
                    "quiz": { "types": ["mcq"], "distractors_de": seed.distractors_de },
                    "tags": [...seed.tags, `item-${i}`],
                    "level": level
                });
            }
            return words;
        };

        // Function to generate unique grammar items
        const generateUniqueGrammar = (count = 200) => {
            // FIX: Initialize grammar as a local array instead of relying on a global variable
            const grammar = [];
            for (let i = 1; i <= count; i++) {
                const seed = baseGrammarSeeds[(i - 1) % baseGrammarSeeds.length];
                const level = i <= 100 ? "A1" : "A2";
                grammar.push({
                    "id": `g-${level}-${String(i).padStart(3, '0')}`,
                    "topic": seed.topic,
                    "rule_de": seed.rule_de,
                    "rule_ar": seed.rule_ar,
                    "question": seed.question,
                    "answer": seed.answer,
                    "type": "mcq",
                    "explanation_de": seed.explanation_de,
                    "explanation_ar": seed.explanation_ar,
                    // Use 'distractors' for grammar items
                    "distractors": seed.distractors,
                    "level": level,
                    "tags": [...seed.tags, `item-${i}`]
                });
            }
            return grammar; // Return the local array
        };

        // All data combined, ensuring all quiz items are set to "mcq" for consistency
        const ALL_QUIZ_ITEMS = {
            words: generateUniqueWords(200),
            grammar: generateUniqueGrammar(200)
        };

        const APP_STORAGE_KEY = 'bilingualStudyProgress';
        const DAY_IN_MS = 24 * 60 * 60 * 1000;

        // --- STATE MANAGEMENT ---
        let state = {
            lang: localStorage.getItem('lang') || 'de',
            theme: localStorage.getItem('theme') || 'light',
            route: localStorage.getItem('route') || '/',
            leniency: false,
            srsProgress: {},
            currentQuiz: {
                category: null,
                items: [],
                currentIndex: 0,
                feedback: null, // 'correct', 'incorrect', null
                showAnswer: false,
                sessionComplete: false,
                userAnswer: '',
                levelFilter: localStorage.getItem('levelFilter') || 'all', // Load filter from storage
                typeFilter: 'all'
            },
            isConfirmingReset: false, // State for confirmation modal
        };

        // --- SRS LOGIC ---
        const SRS = {
            initial: { attempts: 0, correct: 0, streak: 0, lastSeen: 0, interval: 0, ease: 2.5, dueAt: 0 },
            calculateNext: (srsItem, correct) => {
                let { interval, ease, streak } = srsItem;
                const now = Date.now();

                if (correct) {
                    streak += 1;
                    ease = Math.max(1.3, ease + 0.02); // Simplified ease increase

                    if (streak === 1) interval = 1;
                    else if (streak === 2) interval = 6;
                    else interval = Math.round(interval * ease);
                } else {
                    streak = 0;
                    interval = 1;
                    ease = Math.max(1.3, ease - 0.2);
                }

                const nextDueAt = now + interval * DAY_IN_MS;

                return {
                    attempts: srsItem.attempts + 1,
                    correct: srsItem.correct + (correct ? 1 : 0),
                    streak: streak,
                    lastSeen: now,
                    interval: interval,
                    ease: ease,
                    dueAt: nextDueAt,
                };
            }
        };

        // --- UTILITIES ---

        function persistState() {
            localStorage.setItem('lang', state.lang);
            localStorage.setItem('theme', state.theme);
            localStorage.setItem('leniency', state.leniency);
            localStorage.setItem('route', state.route);
            localStorage.setItem('levelFilter', state.currentQuiz.levelFilter); // Persist filter setting
            localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(state.srsProgress));
            applyTheme();
            applyDirection();
        }

        function loadState() {
            const storedProgress = localStorage.getItem(APP_STORAGE_KEY);
            if (storedProgress) {
                try {
                    state.srsProgress = JSON.parse(storedProgress);
                } catch (e) {
                    console.error("Error parsing stored progress:", e);
                }
            }
            applyTheme();
            applyDirection();
        }

        function applyTheme() {
            document.body.className = document.body.className.replace('dark', '').trim();
            if (state.theme === 'dark') {
                document.body.classList.add('dark');
            }
        }

        function applyDirection() {
            document.body.setAttribute('dir', state.lang === 'ar' ? 'rtl' : 'ltr');
            document.body.lang = state.lang === 'ar' ? 'ar' : 'de'; // Set lang attribute for better a11y/rendering
        }

        function displayToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.opacity = '1';
            toast.style.pointerEvents = 'auto';

            // Update RTL position
            toast.className = toast.className.replace(/left-4|right-4/g, '').trim();
            toast.classList.add('fixed', 'bottom-4', state.lang === 'ar' ? 'left-4' : 'right-4', 'bg-blue-600', 'text-white', 'px-4', 'py-3', 'rounded-lg', 'shadow-xl', 'transition-opacity', 'duration-300', 'z-50');

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.pointerEvents = 'none';
            }, duration);
        }

        function updateSrsProgress(itemId, correct) {
            const current = state.srsProgress[itemId] || SRS.initial;
            const updated = SRS.calculateNext(current, correct);
            state.srsProgress = { ...state.srsProgress, [itemId]: updated };
            persistState();
        }

        function getAllItemsWithSrs() {
            const allItems = [...ALL_QUIZ_ITEMS.words, ...ALL_QUIZ_ITEMS.grammar];
            return allItems.map(item => ({
                ...item,
                srs: state.srsProgress[item.id] || SRS.initial
            }));
        }

        // --- ROUTING AND RENDERING ---

        function navigate(newRoute) {
            if (state.route === '/review' || state.route.startsWith('/quiz') || state.route === '/words' || state.route === '/grammar') {
                // Reset quiz session state when leaving a quiz view
                state.currentQuiz = {
                    category: null, items: [], currentIndex: 0, feedback: null, showAnswer: false, sessionComplete: false, userAnswer: '',
                    levelFilter: state.currentQuiz.levelFilter || 'all', typeFilter: 'all' // Preserve filter setting
                };
            }
            state.isConfirmingReset = false; // Reset confirmation state on navigation
            state.route = newRoute;
            persistState();
            renderApp();
        }

        function createElement(tag, classes, innerHTML = '', attributes = {}) {
            const el = document.createElement(tag);
            if (classes) el.className = classes;
            if (innerHTML) el.innerHTML = innerHTML;
            for (const key in attributes) {
                el.setAttribute(key, attributes[key]);
            }
            return el;
        }

        function renderHeader() {
            const t = L[state.lang];
            const dueItems = getAllItemsWithSrs().filter(item => item.srs.dueAt <= Date.now() || item.srs.attempts === 0);
            const dueTodayCount = dueItems.length;

            const NavItem = (to, text, count = 0) => {
                const isActive = state.route === to;
                const btn = createElement('button',
                    `px-3 py-2 rounded-lg transition-colors duration-200 text-sm font-medium ${isActive ? 'bg-blue-600 text-white shadow-md' : 'text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'}`,
                    `${text}`, { 'data-route': to }
                );
                // Use inline onclick here as these are static
                btn.onclick = () => navigate(to);

                if (count > 0) {
                    const span = createElement('span', 'ml-1 px-2 py-0.5 text-xs font-bold bg-red-500 text-white rounded-full', `${count}`);
                    btn.appendChild(span);
                }
                return btn;
            };

            const header = createElement('header', 'bg-white dark:bg-gray-900 shadow-md border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10');
            const container = createElement('div', 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col md:flex-row justify-between items-center');

            const title = createElement('h1', 'text-2xl font-extrabold text-gray-900 dark:text-white mb-3 md:mb-0', t.appTitle);

            const nav = createElement('nav', 'flex flex-wrap justify-center gap-2');
            nav.appendChild(NavItem('/', t.home));
            nav.appendChild(NavItem('/words', t.words));
            nav.appendChild(NavItem('/grammar', t.grammar));
            nav.appendChild(NavItem('/review', t.review, dueTodayCount));
            nav.appendChild(NavItem('/settings', t.settings));

            container.appendChild(title);
            container.appendChild(nav);
            header.appendChild(container);
            return header;
        }

        function renderHome() {
            const t = L[state.lang];
            const allItems = getAllItemsWithSrs();
            const totalItemCount = allItems.length;
            const dueTodayCount = allItems.filter(item => item.srs.dueAt <= Date.now() || item.srs.attempts === 0).length;
            const learnedCount = allItems.filter(s => s.srs.streak > 0 && s.srs.dueAt > 0).length;

            const StatCard = (title, value, color) => {
                const card = createElement('div', `p-3 rounded-lg bg-white dark:bg-gray-800 border border-${color}-400`);
                card.appendChild(createElement('p', `text-3xl font-extrabold text-${color}-600 dark:text-${color}-400`, value));
                card.appendChild(createElement('p', 'text-sm text-gray-500 dark:text-gray-300', title));
                return card;
            };

            const Card = (category) => {
                const isWords = category === 'words';
                const color = isWords ? 'blue' : 'green';
                const text = isWords ? t.words : t.grammar;
                const count = isWords ? ALL_QUIZ_ITEMS.words.length : ALL_QUIZ_ITEMS.grammar.length;

                const card = createElement('div', `bg-white dark:bg-gray-800 p-6 rounded-xl shadow-xl hover:shadow-2xl transition-shadow cursor-pointer border-t-4 border-${color}-500`, '', { 'data-category': category });
                card.onclick = () => navigate(`/${category}`);
                card.appendChild(createElement('h3', `text-3xl font-bold text-${color}-600 dark:text-${color}-400 mb-2`, text));
                card.appendChild(createElement('p', 'text-gray-600 dark:text-gray-300 mb-4', `${t.totalItems}: ${count}`));
                card.appendChild(createElement('button', `text-${color}-600 dark:text-${color}-400 font-semibold hover:underline`, t.startQuiz));
                return card;
            };

            const container = createElement('div', 'p-6 space-y-8 max-w-4xl mx-auto');
            container.setAttribute('dir', state.lang === 'ar' ? 'rtl' : 'ltr');

            container.appendChild(createElement('h2', 'text-4xl font-extrabold text-gray-900 dark:text-white mb-6 border-b pb-3 border-gray-200 dark:border-gray-700', t.welcome));

            const grid = createElement('div', 'grid grid-cols-1 md:grid-cols-2 gap-6');
            grid.appendChild(Card('words'));
            grid.appendChild(Card('grammar'));
            container.appendChild(grid);

            const progressCard = createElement('div', 'bg-gray-100 dark:bg-gray-700 p-6 rounded-xl shadow-lg border-l-4 border-indigo-500');
            progressCard.appendChild(createElement('h3', 'text-2xl font-bold text-indigo-600 dark:text-indigo-400 mb-4', t.progress));

            const statsGrid = createElement('div', 'grid grid-cols-3 gap-4 text-center');
            statsGrid.appendChild(StatCard(t.dueItems, dueTodayCount, 'red'));
            statsGrid.appendChild(StatCard(t.totalLearned, learnedCount, 'blue'));
            statsGrid.appendChild(StatCard(t.totalItems, totalItemCount, 'gray'));
            progressCard.appendChild(statsGrid);

            progressCard.appendChild(createElement('p', 'mt-4 text-center text-lg font-medium text-gray-700 dark:text-gray-300', t.prepB1));
            container.appendChild(progressCard);

            return container;
        }

        function renderSettings() {
            const t = L[state.lang];

            const SettingCard = (title, content) => {
                const card = createElement('div', 'bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg flex justify-between items-center');
                card.appendChild(createElement('h3', 'text-lg font-semibold text-gray-900 dark:text-white', title));
                const contentWrapper = createElement('div', 'flex items-center space-x-3');
                contentWrapper.appendChild(content);
                card.appendChild(contentWrapper);
                return card;
            };

            // Language Toggle
            // Note: Language buttons are kept simple as they represent the change action itself
            const langButton = createElement('button', 'px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors', `${state.lang === 'de' ? '🇩🇪 Deutsch' : '🇦🇪 العربية'} \u2192 ${state.lang === 'de' ? '🇦🇪 العربية' : '🇩🇪 Deutsch'}`);
            langButton.onclick = () => { state.lang = state.lang === 'de' ? 'ar' : 'de'; navigate('/settings'); };

            // Theme Toggle
            const themeButton = createElement('button', 'px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-800 transition-colors dark:bg-gray-200 dark:text-gray-800 dark:hover:bg-gray-300', `${state.theme === 'light' ? '🌙' : '☀️'} ${t[state.theme === 'light' ? 'dark' : 'light']}`);
            themeButton.onclick = () => { state.theme = state.theme === 'light' ? 'dark' : 'light'; navigate('/settings'); };

            // Progress Management
            const progressGroup = createElement('div', 'flex flex-col space-y-3');

            const exportButton = createElement('button', 'px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors', t.exportProgress);
            exportButton.onclick = handleExportProgress;
            progressGroup.appendChild(exportButton);

            const importLabel = createElement('label', 'block w-full text-center px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition-colors cursor-pointer');
            const importInput = createElement('input', 'hidden', '', { type: 'file', accept: '.json' });
            importInput.onchange = handleImportProgress;
            importLabel.appendChild(importInput);
            importLabel.appendChild(document.createTextNode(t.importProgress));
            progressGroup.appendChild(importLabel);

            // Conditional Reset Button or Confirmation Box
            if (state.isConfirmingReset) {
                const confirmBox = createElement('div', 'p-4 bg-red-100 dark:bg-red-900 border border-red-500 rounded-lg space-y-3');
                confirmBox.appendChild(createElement('p', 'font-semibold text-red-800 dark:text-red-200', t.confirmReset));
                const btnGroup = createElement('div', 'flex justify-end space-x-3');

                // Use new localization keys
                const cancelBtn = createElement('button', 'px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors', t.cancelBtnText);
                cancelBtn.onclick = cancelReset;

                const confirmBtn = createElement('button', 'px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors', t.confirmResetBtnText);
                confirmBtn.onclick = confirmReset;

                btnGroup.appendChild(cancelBtn);
                btnGroup.appendChild(confirmBtn);
                confirmBox.appendChild(btnGroup);
                progressGroup.appendChild(confirmBox);

            } else {
                const resetButton = createElement('button', 'px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors', t.resetProgress);
                resetButton.onclick = handleResetProgress;
                progressGroup.appendChild(resetButton);
            }

            const container = createElement('div', 'p-4 max-w-xl mx-auto space-y-6');
            container.setAttribute('dir', state.lang === 'ar' ? 'rtl' : 'ltr');
            container.appendChild(createElement('h2', 'text-3xl font-bold text-gray-900 dark:text-white mb-6 border-b pb-2', t.settings));

            container.appendChild(SettingCard(t.currentLang, langButton));
            container.appendChild(SettingCard(t.theme, themeButton));
            container.appendChild(SettingCard(t.progress, progressGroup));

            return container;
        }

        // --- QUIZ ENGINE IMPLEMENTATION ---

        function setupQuiz(category, items) {
            const itemsWithSrs = items.map(item => ({ ...item, srs: state.srsProgress[item.id] || SRS.initial }));

            // Shuffle and take a maximum of 100 items for the session
            const shuffledItems = itemsWithSrs.sort(() => Math.random() - 0.5).slice(0, 100);

            state.currentQuiz = {
                category,
                items: shuffledItems,
                currentIndex: 0,
                feedback: null,
                showAnswer: false,
                sessionComplete: false,
                userAnswer: '',
                levelFilter: state.currentQuiz.levelFilter || 'all',
                typeFilter: 'all'
            };
        }

        function getCurrentQuizItem() {
            return state.currentQuiz.items[state.currentQuiz.currentIndex];
        }

        /**
         * Checks the user's selected answer against the correct one.
         * @param {string} userAnswer The selected option text.
         */
        function checkAnswer(userAnswer) {
            if (state.currentQuiz.feedback || state.currentQuiz.sessionComplete) return;

            const item = getCurrentQuizItem();
            // The correct answer is always the German term (item.de) or the grammar answer (item.answer)
            const correctAnswer = item.answer || item.de;

            // Comparison is now strict string matching
            const isCorrect = userAnswer === correctAnswer;

            state.currentQuiz.feedback = isCorrect ? 'correct' : 'incorrect';
            state.currentQuiz.userAnswer = userAnswer;
            updateSrsProgress(item.id, isCorrect);
            renderQuizContent();
        }

        function showAnswerAndMarkIncorrect() {
            if (state.currentQuiz.feedback || state.currentQuiz.sessionComplete) return;
            const item = getCurrentQuizItem();
            state.currentQuiz.showAnswer = true;
            state.currentQuiz.feedback = 'incorrect';
            updateSrsProgress(item.id, false);
            renderQuizContent();
        }

        function nextItem() {
            if (state.currentQuiz.currentIndex < state.currentQuiz.items.length - 1) {
                state.currentQuiz.currentIndex++;
                state.currentQuiz.feedback = null;
                state.currentQuiz.showAnswer = false;
                state.currentQuiz.userAnswer = '';
                renderQuizContent();
            } else {
                state.currentQuiz.sessionComplete = true;
                displayToast(L[state.lang].sessionComplete);
                renderQuizContent();
            }
        }

        function renderQuizContent() {
            const item = getCurrentQuizItem();
            const t = L[state.lang];
            const quizContainer = document.getElementById('quiz-container');

            // CRITICAL CHECK: If the container isn't ready yet (e.g., still rendering the main page), exit.
            if (!quizContainer) {
                return;
            }

            if (!item || state.currentQuiz.sessionComplete) {
                quizContainer.innerHTML = `
                    <div class="p-6 text-center text-green-600 dark:text-green-400">
                        <p class="text-3xl font-bold mb-4">${t.sessionComplete}</p>
                        <button onclick="navigate('/')" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">${t.home}</button>
                    </div>
                `;
                return;
            }

            const isWords = item.id.startsWith('w-');
            const itemSrs = state.srsProgress[item.id] || SRS.initial;
            // Use item.answer for grammar (gap-fill) and item.de for words (translation)
            const correctAnswer = item.answer || item.de;

            // Consolidate distractor retrieval
            // Words use item.quiz?.distractors_de, Grammar uses item.distractors
            const distractors = item.quiz?.distractors_de || item.distractors || [];
            const itemTopic = isWords ? (item.pos || t.words) : (item.topic || t.grammar);

            // Question is always the Arabic term for words, or the German phrase with a gap for grammar
            const itemQuestion = isWords ? item.ar : item.question;

            const itemExplanation = state.lang === 'de' ? (item.explanation_de || item.example_de) : (item.explanation_ar || item.example_ar);

            let contentHTML = '';

            // 1. Progress Bar
            const progress = ((state.currentQuiz.currentIndex + 1) / state.currentQuiz.items.length) * 100;
            contentHTML += `
                <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full">
                    <div class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: ${progress}%"></div>
                </div>
            `;

            // 2. Item Info
            contentHTML += `
                <div class="flex justify-between text-sm text-gray-500 dark:text-gray-400">
                    <span>${t.topic}: ${itemTopic}</span>
                    <span>${t.level}: ${item.level}</span>
                </div>
            `;

            // 3. Question Card
            // The question is presented in the non-German language (Arabic) or as a gap-fill.
            const questionLang = isWords ? 'ar' : 'de';
            contentHTML += `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border-2 border-blue-500">
                    <p class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">
                        ${state.currentQuiz.currentIndex + 1} / ${state.currentQuiz.items.length}
                    </p>
                    <p lang="${questionLang}" class="text-3xl font-bold leading-relaxed text-gray-800 dark:text-gray-200">
                        ${itemQuestion.replace('___', '<span class="text-red-500 dark:text-red-400">______</span>')}
                    </p>
                    ${isWords && item.gender ? `<p class="mt-2 text-blue-600 dark:text-blue-400 font-medium">${item.gender}</p>` : ''}
                </div>
            `;

            // 4. Quiz Options (Always MCQ)
            const options = [correctAnswer, ...distractors].filter(Boolean);
            const mcqOptions = [...new Set(options)].sort(() => Math.random() - 0.5);

            if (!state.currentQuiz.feedback) {
                // Render MCQ buttons
                contentHTML += `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">`;
                mcqOptions.forEach((option, index) => {
                    // Use a function to safely escape quotes for inline onclick
                    const safeOption = option.replace(/'/g, "\\'");
                    contentHTML += `
                        <button
                            onclick="checkAnswer('${safeOption}')"
                            class="quiz-option w-full text-left p-4 bg-gray-100 dark:bg-gray-700 rounded-lg text-lg font-medium text-gray-900 dark:text-white hover:bg-blue-100 dark:hover:bg-blue-700 transition-colors shadow-sm focus:outline-none focus:ring-4 focus:ring-blue-500/50"
                            data-mcq-key="${index + 1}"
                            lang="de"
                            tabindex="0"
                        >
                            <span class="font-mono text-sm mr-2 opacity-70">(${index + 1})</span>
                            ${option}
                        </button>
                    `;
                });
                contentHTML += `</div>`;

                // Add show answer button
                contentHTML += `
                     <button onclick="showAnswerAndMarkIncorrect()" class="w-full px-6 py-3 bg-red-600 text-white rounded-lg font-semibold text-lg hover:bg-red-700 transition-colors shadow-md mt-4">
                        ${t.showAnswer}
                    </button>
                `;
            }

            // 5. Feedback / Answer
            if (state.currentQuiz.feedback || state.currentQuiz.showAnswer) {
                const isCorrect = state.currentQuiz.feedback === 'correct';

                // Highlight the selected answer
                const selectedAnswer = state.currentQuiz.userAnswer;
                const feedbackOptions = mcqOptions.map(option => {
                    let classes = "p-3 rounded-lg border-2 text-md font-medium mb-1";
                    let prefix = '';

                    if (option === correctAnswer) {
                        // Correct Answer
                        classes += " bg-green-200 dark:bg-green-900 border-green-500 text-green-800 dark:text-green-200 font-bold";
                        prefix = '✅ ';
                    } else if (option === selectedAnswer && !isCorrect) {
                        // Incorrect Selected Answer
                        classes += " bg-red-200 dark:bg-red-900 border-red-500 text-red-800 dark:text-red-200 line-through";
                        prefix = '❌ ';
                    } else {
                        // Unselected Distractor
                        classes += " bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 opacity-60";
                    }

                    return `<div class="${classes}" lang="de">${prefix}${option}</div>`;
                }).join('');


                contentHTML += `
                    <div class="p-4 rounded-xl shadow-inner ${isCorrect ? 'bg-green-100 dark:bg-green-900/50 border-green-500' : 'bg-red-100 dark:bg-red-900/50 border-red-500'}">
                        <p class="text-xl font-bold ${isCorrect ? 'text-green-700 dark:text-green-300' : 'text-red-700 dark:text-red-300'} mb-3">
                            ${isCorrect ? t.correct : t.incorrect}
                        </p>

                        <div class="space-y-1 mt-3">
                            ${feedbackOptions}
                        </div>

                        <div class="mt-3 pt-2 border-t border-dashed border-gray-400 dark:border-gray-600 text-sm italic text-gray-600 dark:text-gray-400">
                            ${itemExplanation || ''}
                        </div>
                    </div>
                    <button onclick="nextItem()" class="w-full px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold text-lg hover:bg-indigo-700 transition-colors shadow-md animate-pulse">
                        ${t.next}
                    </button>
                `;
            }

            // 6. SRS Status
            contentHTML += `
                <div class="text-center text-sm text-gray-500 dark:text-gray-400 pt-4">
                    <p>${t.streak}: ${itemSrs.streak} | ${t.attempts}: ${itemSrs.attempts} (${t.correctCount}: ${itemSrs.correct})</p>
                </div>
            `;

            quizContainer.innerHTML = `<div class="space-y-6 p-4 max-w-xl mx-auto">${contentHTML}</div>`;
        }

        function renderQuizView(category) {
            const t = L[state.lang];
            const rawItems = category === 'words' ? ALL_QUIZ_ITEMS.words : ALL_QUIZ_ITEMS.grammar;

            const filteredItems = rawItems
                .filter(item => state.currentQuiz.levelFilter === 'all' || item.level === state.currentQuiz.levelFilter);

            // Get the level of the first item in the current session (if any)
            const currentItemLevel = state.currentQuiz.items[0]?.level;

            // If quiz not started, or category changed, or the filter setting has changed, restart session
            if (state.currentQuiz.category !== category || state.currentQuiz.items.length === 0 || currentItemLevel !== state.currentQuiz.levelFilter) {
                // Check if there are any items to quiz before attempting setup
                if (filteredItems.length === 0) {
                    return createElement('div', 'p-6 text-center text-gray-500 dark:text-gray-400', `
                        <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2">${category === 'words' ? t.words : t.grammar}</h2>
                        <p class="text-xl font-semibold mt-8">${t.notDue} (0/${rawItems.length} available after filtering)</p>
                    `);
                }
                setupQuiz(category, filteredItems);
            }

            const container = createElement('div', 'p-4');
            container.setAttribute('dir', state.lang === 'ar' ? 'rtl' : 'ltr');

            // Removed the item count from the title
            container.appendChild(createElement('h2', 'text-3xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2', `${category === 'words' ? t.words : t.grammar}`));

            // Filters Section (Simplified to only Level Filter)
            const filterDiv = createElement('div', 'flex flex-wrap gap-4 mb-6');

            // Level Filter
            const levelSelect = createElement('select', 'p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white', '', { id: 'level-filter' });
            levelSelect.innerHTML = `
                <option value="all">${t.filterLevel}: ${t.totalItems}</option>
                <option value="A1" ${state.currentQuiz.levelFilter === 'A1' ? 'selected' : ''}>${t.level} A1</option>
                <option value="A2" ${state.currentQuiz.levelFilter === 'A2' ? 'selected' : ''}>${t.level} A2</option>
            `;
            levelSelect.onchange = (e) => {
                state.currentQuiz.levelFilter = e.target.value;
                state.currentQuiz.items = []; // Force restart quiz session
                persistState(); // Save the new filter setting
                renderApp(); // Rerender immediately
            };
            filterDiv.appendChild(levelSelect);

            container.appendChild(filterDiv);

            // Container for the dynamic quiz content
            const quizContainer = createElement('div', '', '', { id: 'quiz-container' });
            container.appendChild(quizContainer);

            return container;
        }

        function renderReview() {
            const t = L[state.lang];
            const dueItems = getAllItemsWithSrs()
                .filter(item => item.srs.dueAt <= Date.now() || item.srs.attempts === 0)
                .sort((a, b) => a.srs.dueAt - b.srs.dueAt); // Prioritize overdue

            // Check if there are any items to quiz
            if (dueItems.length === 0) {
                return createElement('div', 'p-6 text-center text-gray-500 dark:text-gray-400', `
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2">${t.review}</h2>
                    <p class="text-xl font-semibold mt-8">${t.notDue}</p>
                `);
            }

            // Start review session if not already in one
            if (state.currentQuiz.category !== 'review' || state.currentQuiz.items.length === 0) {
                // Ensure a minimum of 10 items or all due items are in the session
                const sessionSize = Math.min(dueItems.length, 50);
                setupQuiz('review', dueItems.slice(0, sessionSize));
            }

            const container = createElement('div', 'p-4');
            container.setAttribute('dir', state.lang === 'ar' ? 'rtl' : 'ltr');

            // Removed the item count from the title
            container.appendChild(createElement('h2', 'text-3xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2', `${t.review}`));

            const quizContainer = createElement('div', '', '', { id: 'quiz-container' });
            container.appendChild(quizContainer);

            return container;
        }


        // --- PROGRESS HANDLERS (Import/Export/Reset) ---

        function handleExportProgress() {
            const dataStr = JSON.stringify(state.srsProgress, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const exportFileDefaultName = 'bilingual-progress.json';

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            displayToast(L[state.lang].exportProgress + "!");
        }

        function handleImportProgress(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Basic validation
                    if (typeof importedData === 'object' && Object.keys(importedData).every(key => key.startsWith('w-') || key.startsWith('g-'))) {
                        state.srsProgress = importedData;
                        persistState();
                        displayToast(L[state.lang].importSuccess);
                        navigate('/settings'); // Re-render settings to show imported state
                    } else {
                        displayToast(L[state.lang].importFail);
                    }
                } catch (error) {
                    console.error("Import error:", error);
                    displayToast(L[state.lang].importFail);
                }
            };
            reader.readAsText(file);
        }

        function handleResetProgress() {
            // Replaced window.confirm with state change to show confirmation UI
            state.isConfirmingReset = true;
            navigate('/settings');
        }

        function confirmReset() {
            state.srsProgress = {};
            state.isConfirmingReset = false;
            // Also reset the filter state upon full progress reset
            state.currentQuiz.levelFilter = 'all';
            persistState();
            displayToast(L[state.lang].resetProgress + "!");
            navigate('/settings');
        }

        function cancelReset() {
            state.isConfirmingReset = false;
            navigate('/settings');
        }


        // --- MAIN RENDER LOOP ---

        function renderApp() {
            const appRoot = document.getElementById('app-root');
            appRoot.innerHTML = '';

            const mainContainer = createElement('div', 'bg-gray-50 dark:bg-gray-900 min-h-screen transition-colors duration-300');
            mainContainer.appendChild(renderHeader());

            const mainContent = createElement('main', 'py-8');

            let content;
            switch (state.route) {
                case '/words':
                case '/grammar':
                    content = renderQuizView(state.route.substring(1));
                    break;
                case '/review':
                    content = renderReview();
                    break;
                case '/settings':
                    content = renderSettings();
                    break;
                case '/':
                default:
                    content = renderHome();
            }
            mainContent.appendChild(content);
            mainContainer.appendChild(mainContent);
            appRoot.appendChild(mainContainer);

            // Defer rendering quiz content until the main HTML structure is in the DOM.
            if (state.route === '/words' || state.route === '/grammar' || state.route === '/review') {
                setTimeout(renderQuizContent, 0);
            }
        }

        // --- KEYBOARD SHORTCUTS (NO SPACE/ENTER) ---

        document.addEventListener('keydown', (e) => {
            const currentItem = getCurrentQuizItem();
            // Enter and Space functionality intentionally removed in the previous iteration.
            if (!currentItem || state.currentQuiz.sessionComplete) return;

            // Retaining the number key functionality for MCQs (1, 2, 3, 4)
            if (!state.currentQuiz.feedback && e.key >= '1' && e.key <= '4') {
                e.preventDefault();
                const optionIndex = parseInt(e.key, 10) - 1;
                const button = document.querySelector(`.quiz-option[data-mcq-key="${optionIndex + 1}"]`);
                if (button) {
                    // Directly call checkAnswer with the button's intended value for robustness
                    const value = button.getAttribute('onclick').match(/checkAnswer\('(.*)'\)/)?.[1] || button.textContent.trim().replace(/^\(\d\)\s*/, '');
                    if (value) checkAnswer(value);
                }
            }
        });

        // NEW: Expose necessary functions globally for inline HTML event handlers (due to module scope)
        window.navigate = navigate;
        window.checkAnswer = checkAnswer;
        window.showAnswerAndMarkIncorrect = showAnswerAndMarkIncorrect;
        window.nextItem = nextItem;
        window.confirmReset = confirmReset;
        window.cancelReset = cancelReset;

        // Initialize the app on load
        window.onload = () => {
            loadState();
            renderApp();
        };

        // PWA Note: For actual PWA capability, a service worker registration and manifest would be added here.
    </script>
</body>

</html>